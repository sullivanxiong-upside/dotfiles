Security Best Practices

## Input Validation
- Validate and sanitize all user inputs
- Use parameterized queries for SQL (never string interpolation)
- Escape output when rendering user content (XSS prevention)
- Validate file uploads (type, size, content)
- Check permission before allowing operations

## Authentication & Authorization
- Check authentication on every protected endpoint
- Verify user has permission for requested resource/operation
- Don't trust client-sent user IDs - use session/token data
- Use secure session management (HTTPOnly, Secure cookies)
- Implement rate limiting on auth endpoints

## Data Protection
- Encrypt sensitive data at rest and in transit
- Use HTTPS for all production traffic
- Hash passwords with bcrypt/argon2 (never store plaintext)
- Don't log sensitive data (passwords, tokens, PII)
- Use environment variables for secrets, not hardcoded values

## Common Vulnerabilities to Prevent
- SQL injection: Use parameterized queries
- XSS: Escape user content, use CSP headers
- CSRF: Use CSRF tokens on state-changing operations
- Path traversal: Validate and sanitize file paths (see pattern below)
- Mass assignment: Explicitly allow fields for updates

## Path Traversal Prevention

When accepting file paths from external input (user input, API requests, config):

```python
# Don't: Simple string checks can be bypassed
if ".." in path:  # Misses encoded variants, symlinks
    raise ValueError("Invalid path")

# Do: Use Path.resolve() and verify containment
from pathlib import Path

def safe_read_file(base_dir: Path, user_path: str) -> str:
    if user_path.startswith("/"):
        raise ValueError("Absolute paths not allowed")

    full_path = (base_dir / user_path).resolve()
    if not full_path.is_relative_to(base_dir.resolve()):
        raise ValueError("Path traversal not allowed")

    return full_path.read_text()
```

Key points:
- `resolve()` normalizes the path and follows symlinks
- `is_relative_to()` verifies the resolved path stays within bounds
- Check for absolute paths separately (leading `/`)
- This catches `..`, encoded sequences, and symlink escapes

## API Security
- Require authentication for non-public endpoints
- Validate request sizes and rate limit
- Return appropriate error codes (avoid info leakage)
- Use API keys/tokens securely
- Implement proper CORS policies

## Security Review Checklist
- User input is validated before use
- Database queries use parameters, not concatenation
- Authentication is checked on protected routes
- User has permission for requested operation
- Sensitive data is not logged or exposed in errors
