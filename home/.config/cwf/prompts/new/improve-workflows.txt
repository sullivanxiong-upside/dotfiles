You are helping me improve the cwf (claude-wf) and gwf (git workflow) CLI tools.

{{GIT_SAFETY}}

{{WRITING_STYLE}}

## Context

These are the workflow automation tools located in ~/repos/dotfiles/bin/:

**cwf (cwf):**
- Unified CLI for Claude-powered workflows
- Categories: review, customer-mgmt, feature, agent, prepare-release, new, completion
- Uses prompt files in ~/.config/claude-wf/prompts/
- Supports template variables and shared fragments
- Self-extending with meta-commands

**gwf (gwf):**
- Git workflow CLI with intelligent worktree management
- Categories: local, remote, worktree, pr, inspect, completion
- Shorthand syntax for common git operations
- Integration with GitHub CLI (gh)

## Your Task

Help me improve these workflow tools. Follow this process:

### Phase 1: Understanding Phase

First, ask me:
1. What aspect do I want to improve?
   - cwf, gwf, or both?
2. What type of improvement?
   - Add new feature/command
   - Refactor existing code
   - Fix a bug
   - Optimize performance
   - Improve documentation
   - Enhance error handling
   - Other
3. Describe the current behavior and desired behavior

### Phase 2: Analysis Phase

Based on the improvement type:

**For new features/commands:**
- Read relevant script files to understand current structure
- Identify where the new feature should integrate
- Check for similar existing functionality
- Look at existing patterns to follow

**For refactoring/bugs:**
- Read the relevant code sections
- Understand the current implementation
- Identify the issue or area for improvement
- Consider impact on existing functionality

**For documentation:**
- Check current documentation structure
- Identify what needs updating
- Look for related docs that may need changes

### Phase 3: Planning Phase

Present a detailed plan:

1. **What will change:**
   - Files to create or modify
   - New functions/commands to add
   - Code sections to refactor
   - Documentation to update

2. **Implementation approach:**
   - Show code changes with clear before/after examples
   - Explain design decisions
   - Identify any breaking changes
   - Consider backward compatibility

3. **Files involved:**
   - ~/repos/dotfiles/bin/cwf
   - ~/repos/dotfiles/bin/gwf
   - Prompt files in ~/.config/claude-wf/prompts/
   - Completion scripts (gwf-completion.bash, generated completions)
   - Documentation (README.md, docs/)

4. **Testing plan:**
   - Manual testing commands to verify changes
   - Edge cases to consider
   - Regression tests (commands that should still work)

### Phase 4: Confirmation Phase

Present the complete plan and ask for approval:

```markdown
# Improvement Plan for [cwf/gwf]

## Summary
[Brief description of the improvement]

## Changes Required

### Files to Create
- [List new files with descriptions]

### Files to Modify
- [List files with summary of changes]

## Implementation Details

### [File 1]
**Before:**
```bash
[Current code]
```

**After:**
```bash
[Proposed code]
```

**Rationale:** [Explain why this change]

[Repeat for each file]

## Testing Plan

**Test commands:**
```bash
# Test 1: [Description]
command to test

# Test 2: [Description]
command to test
```

**Expected behavior:**
- [What should happen]

## Backward Compatibility
- [Any breaking changes?]
- [Migration needed?]

## Documentation Updates
- [List docs to update]
```

**Ask for explicit confirmation before implementing.**

### Phase 5: Implementation Phase

Once confirmed:

1. **Make the changes:**
   - Use Edit tool for modifications
   - Use Write tool for new files
   - Make changes atomically and clearly

2. **Verify changes:**
   - Show what was changed
   - Confirm files are correct
   - Check for syntax errors

3. **Update documentation:**
   - Update README.md if needed
   - Update relevant docs/ files
   - Update completion scripts if commands changed
   - Keep docs synchronized with implementation

4. **Provide testing guidance:**
   ```bash
   # Commands to test the changes
   [Specific test commands]
   ```

5. **Report completion:**
   ```markdown
   # Improvement Complete

   ## Changes Applied
   - ✓ [File 1]: [What changed]
   - ✓ [File 2]: [What changed]

   ## Testing
   Run these commands to verify:
   ```bash
   [Test commands]
   ```

   ## Next Steps
   - [Any follow-up work needed]
   - [Suggestions for future improvements]
   ```

## Best Practices

- **Maintain backward compatibility** unless explicitly asked to break it
- **Follow existing code patterns** in the scripts
- **Update all relevant files** together (scripts, docs, completion)
- **Test changes** with real commands before marking complete
- **Keep functions modular** and well-documented
- **Use consistent naming** (kebab-case for commands, snake_case for functions)
- **Clear error messages** that are actionable
- **Update command registry** and metadata in cwf

## Critical Checklists

### When Adding/Modifying Categories

Categories require updates in **7+ locations**. Use this checklist:

1. **cwf - Registry (line ~30):**
   ```bash
   ["category:subcommand"]="category/subcommand.txt"
   ```

2. **cwf - CATEGORY_DESC (line ~41):**
   ```bash
   ["category"]="Description"
   ```

3. **cwf - SUBCOMMAND_DESC (line ~51):**
   ```bash
   ["category:subcommand"]="Subcommand description"
   ```

4. **cwf - Bash completion categories (line ~393):**
   ```bash
   COMPREPLY=($(compgen -W "... category ..." -- "$cur"))
   ```

5. **cwf - Bash completion subcommand case (line ~407):**
   ```bash
   category)
     COMPREPLY=($(compgen -W "subcommand1 subcommand2" -- "$cur"))
     ;;
   ```

6. **cwf - Zsh completion categories (line ~456):**
   ```bash
   'category:Description'
   ```

7. **cwf - Zsh completion subcommand case (line ~486):**
   ```bash
   category)
     subcommands=('subcmd:Description')
     _describe -t subcommands 'subcommand' subcommands
     return 0
     ;;
   ```

8. **Prompt file location:**
   ```bash
   mkdir -p ~/.config/claude-wf/prompts/category
   # Create or move prompt file
   ```

9. **README.md - Command Categories section:**
   Add new category with its subcommands

10. **README.md - Examples section:**
    Add usage examples for new commands

11. **README.md - Directory structure:**
    Update prompt directory tree

### Testing Completions

Always test both bash and zsh completions:

```bash
# Test category appears
cwf completion bash | grep "category"
cwf completion zsh | grep "category"

# Test subcommands appear
cwf completion bash | grep -A 3 "category)"
cwf completion zsh | grep -A 5 "category)"

# Test actual completion works
cwf category <TAB>
cwf category subcommand --help
```

### Shell Completion Best Practices

From completion-setup.md research:

1. **Symlinks over aliases** - Use ~/.local/bin symlinks for PATH availability
2. **Lazy-loading** - Use `source <(command completion shell)` for on-demand loading
3. **Cross-platform** - Support both bash and zsh natively (no translation)
4. **Process substitution** - Avoids tempfiles and startup delays

### Atomic Operations

When moving/creating files:
```bash
# Good - atomic
mkdir -p target/dir && mv source/file target/dir/

# Bad - can fail mid-operation
mkdir target/dir
mv source/file target/dir/
```

### Real-World Example: Adding "agent" Category

This example shows all locations that were updated when adding the "agent" category:

```bash
# 1. Update COMMAND_REGISTRY
["agent:chat"]="agent/chat.txt"

# 2. Update CATEGORY_DESC
["agent"]="Research and learning"

# 3. Update SUBCOMMAND_DESC
["agent:chat"]="Research and learn about specific topics with expert guidance"

# 4. Bash completion - categories
COMPREPLY=($(compgen -W "review customer-mgmt feature agent prepare-release new completion help" -- "$cur"))

# 5. Bash completion - subcommands
agent)
  COMPREPLY=($(compgen -W "chat" -- "$cur"))
  ;;

# 6. Zsh completion - categories
'agent:Research and learning'

# 7. Zsh completion - subcommands
agent)
  subcommands=('chat:Research and learn about specific topics')
  _describe -t subcommands 'subcommand' subcommands
  return 0
  ;;

# 8. Create directory and move/create prompt file
mkdir -p ~/.config/claude-wf/prompts/agent
# Then create agent/chat.txt

# 9-11. Update README.md
### Agent (Research and Learning)
- `chat` - Research and learn about specific topics with expert guidance

# Example usage:
cwf agent chat "How do I implement distributed caching with Redis?"
```

Missing ANY of these locations breaks functionality or completion!

## File Locations Reference

**Scripts:**
- Main: ~/repos/dotfiles/bin/{cwf,gwf}
- Completion: ~/repos/dotfiles/bin/gwf-completion.bash

**Config & Prompts:**
- Prompts: ~/.config/claude-wf/prompts/**/*.txt
- Shared: ~/.config/claude-wf/prompts/shared/*.txt
- Config: ~/.config/gwf/ (optional)

**Documentation:**
- Main: ~/repos/dotfiles/bin/README.md
- Docs: ~/repos/dotfiles/docs/{cwf-meta-commands.md,gwf.md,workflow-commands.md,completion-setup.md}

## Where to Add Rule Improvements

When improving the workflow by adding new rules or best practices, choose the appropriate location:

### Category-Specific Rules

**Location:** `~/.claude-<category>-rules`

Use for practices specific to one workflow type:
- `~/.claude-feature-rules` - Feature development practices
- `~/.claude-review-rules` - Code review practices
- `~/.claude-customer-mgmt-rules` - Customer management practices
- `~/.claude-prepare-release-rules` - Release preparation practices
- Or create new: `~/.claude-<new-category>-rules`

**When to use:** Practice only applies to one specific workflow category.

**Format:**
```markdown
# Category Rules

## Section Name
Brief description of when this applies.

- Rule 1
- Rule 2
- Rule 3
```

### Shared Fragments

**Location:** `~/.config/cwf/prompts/shared/<fragment>.txt`

Use for practices that apply across multiple workflows. Choose the most relevant fragment:

**Code Quality & Structure:**
- `code-quality-fundamentals.txt` - Constants, types, naming, error handling, code organization
- `reusable-code-extraction.txt` - When/how to extract reusable code, utility structure
- `upside.txt` - Upside Labs-specific standards (use shared libraries, no side effects in constructors, test assertion style, README requirements, DI container specifics, promise rejection, SQL security, avoid generic names, test file organization)

**Testing & Documentation:**
- `testing-documentation.txt` - Test coverage, test organization, documentation standards
- `docs-instructions.txt` - Documentation reading/updating practices

**Security & Safety:**
- `security-best-practices.txt` - Input validation, auth, data protection, vulnerabilities
- `runtime-safety.txt` - Resource management, null safety, error handling, concurrency

**Performance:**
- `performance-database.txt` - Query optimization, N+1 prevention, database best practices

**Git & GitHub:**
- `git-safety.txt` - Git operation safety protocols
- `github-context.txt` - GitHub CLI usage patterns, context gathering

**Project & Workflow:**
- `project-rules.txt` - Project-specific rule file detection
- `planning-guidelines.txt` - When/how to use plan mode
- `worktree-workflow.txt` - Worktree management patterns
- `workflow-commands.txt` - Workflow modes, behaviors, continuous improvement

**Design & Architecture:**
- `design-patterns.txt` - Design pattern considerations
- `api-proto-check.txt` - API/protobuf change reminders

**Misc:**
- `file-reading-reminder.txt` - File reading practices
- `review-and-update-docs.txt` - Documentation update checklist
- `continuous-improvement.txt` - Short reminder about continuous improvement

**When to use:** Practice applies across multiple workflow categories or is universally applicable.

**Or create new fragment:** If none fit, suggest creating a new shared fragment with a descriptive name.

### Global CLAUDE.md

**Location:** `~/.claude/CLAUDE.md`

Use for environment and tooling guidance that applies to ALL Claude Code usage (not just cwf workflows):
- Repository organization and directory structure
- Development environment setup (Nix, direnv, tooling)
- Common pitfalls and troubleshooting
- Tool locations and availability (gwf, cwf, etc.)
- WHERE to find detailed information (pointers to other docs)

**When to use:**
- Environment-level information (not coding practices)
- Tool availability and usage patterns
- Navigation guidance (where things are located)
- Cross-repository conventions

**What NOT to put here:**
- Detailed coding standards (use shared fragments instead)
- Language-specific practices (use repository docs)
- Workflow-specific behaviors (use prompts or category rules)

**Relationship to shared fragments:**
- Global CLAUDE.md can REFERENCE shared fragments ("See upside.txt for coding standards")
- But shouldn't duplicate content that belongs in fragments
- Think of it as a "table of contents" pointing to more detailed resources

### How to Add Rules

When implementing rule improvements:

1. **Identify the practice clearly**
   - What specific behavior should change?
   - What problem does this prevent or solve?

2. **Choose the correct location**
   - Single category? → Category-specific rules
   - Multiple categories? → Shared fragment
   - New domain? → Create new fragment

3. **Follow existing format**
   - Use imperative mood ("Check for X", "Use Y", "Avoid Z")
   - Be concise and actionable
   - Use bullet points for lists
   - Add section headers for organization

4. **Maintain consistency**
   - Match the style of existing content
   - Keep similar density/brevity
   - Use parallel structure in lists

5. **Test the addition**
   - Ensure template variables load correctly
   - Verify file is used by relevant commands
   - Check that rule is clear and actionable

### Example: Adding a New Rule

**Scenario:** Discovered that all database migrations should include rollback scripts.

**Decision:** This is database-specific → Add to `performance-database.txt`

**Implementation:**
```bash
# Read the file
cat ~/.config/cwf/prompts/shared/performance-database.txt

# Edit to add new section or add to existing section
# Add under "## Database Best Practices":
- Include rollback scripts for all migrations
- Test rollback procedure in staging before production
- Document migration dependencies and order
```

**Verification:**
```bash
# Check which prompts use this fragment
grep -r "PERFORMANCE_DATABASE" ~/.config/cwf/prompts/

# Test with a command that uses it
cwf feature dp "test database work"
```

### Template Variable Reference

Each shared fragment is loaded via template variables in cwf.sh:

| Template Variable | Fragment File | Loaded When |
|-------------------|---------------|-------------|
| `{{CODE_QUALITY_FUNDAMENTALS}}` | code-quality-fundamentals.txt | Prompt contains variable |
| `{{TESTING_DOCUMENTATION}}` | testing-documentation.txt | Prompt contains variable |
| `{{SECURITY_CHECKS}}` | security-best-practices.txt | Prompt contains variable |
| `{{RUNTIME_SAFETY}}` | runtime-safety.txt | Prompt contains variable |
| `{{PERFORMANCE_DATABASE}}` | performance-database.txt | Prompt contains variable |
| `{{GIT_SAFETY}}` | git-safety.txt | Prompt contains variable |
| `{{GITHUB_CONTEXT}}` | github-context.txt | Prompt contains variable |
| `{{EXTRACT_REUSABLE_CODE}}` | reusable-code-extraction.txt | Prompt contains variable |
| `{{PROJECT_RULES}}` | project-rules.txt | Prompt contains variable |
| `{{PLANNING_GUIDELINES}}` | planning-guidelines.txt | Prompt contains variable |
| `{{WORKTREE_WORKFLOW}}` | worktree-workflow.txt | Prompt contains variable |
| `{{WORKFLOW_COMMANDS}}` | workflow-commands.txt | Prompt contains variable |
| `{{DESIGN_PATTERNS}}` | design-patterns.txt | Prompt contains variable |
| `{{API_PROTO_CHECK}}` | api-proto-check.txt | Prompt contains variable |
| `{{REVIEW_AND_UPDATE_DOCS}}` | review-and-update-docs.txt | Prompt contains variable |
| `{{UPSIDE_STANDARDS}}` | upside.txt | Prompt contains variable |
| `{{CATEGORY_RULES}}` | Load category-specific rules | Prompt contains variable |

To use a fragment in a prompt, add the template variable:
```markdown
# In a prompt file like feature/dp.txt
{{CODE_QUALITY_FUNDAMENTALS}}
{{PERFORMANCE_DATABASE}}
```

The script loads these fragments only if the prompt references them (lazy loading).

{{REVIEW_AND_UPDATE_DOCS}}
